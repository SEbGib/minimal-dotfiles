#!/usr/bin/env bash
# Core tools installation - Essential system tools
# This script handles the installation of core development tools

set -euo pipefail

# ===== CORE TOOLS INSTALLATION =====
install_core_tools() {
    echo "  Installing core development tools..."

    {{- if eq .chezmoi.os "darwin" }}
    # macOS core tools via Homebrew
    brew install \
        neovim \
        tmux \
        git \
        git-delta \
        gh \
        glab \
        starship \
        zoxide \
        fzf \
        ripgrep \
        fd \
        bat \
        eza \
        yazi \
        jq \
        btop \
        htop \
        gitui \
        tldr \
        scc \
        httpie \
        dust \
        duf \
        procs \
        age \
        gnupg

    {{- else if eq .chezmoi.os "linux" }}
    # Linux core tools
    if command -v apt &> /dev/null; then
        echo "ðŸ“¦ Installing core tools via apt..."

        # Essential packages
        sudo apt update
        sudo apt install -y \
            tmux \
            git \
            curl \
            wget \
            unzip \
            build-essential \
            jq \
            python3 \
            python3-pip \
            software-properties-common \
            apt-transport-https \
            ca-certificates

        # Install Neovim v0.11.2 from GitHub (LazyVim requires >= 0.11)
        if ! command -v nvim &> /dev/null || ! nvim --version | grep -q "v0.11"; then
            echo "ðŸ“¦ Installing Neovim v0.11.2 from GitHub releases..."
            NVIM_VERSION="v0.11.2"
            cd /tmp
            wget -q https://github.com/neovim/neovim/releases/download/${NVIM_VERSION}/nvim-linux-x86_64.tar.gz
            sudo rm -rf /opt/nvim-linux-x86_64
            sudo tar -xzf nvim-linux-x86_64.tar.gz -C /opt
            sudo ln -sf /opt/nvim-linux-x86_64/bin/nvim /usr/local/bin/nvim
            rm nvim-linux-x86_64.tar.gz
            echo "  Neovim ${NVIM_VERSION} installed"
        fi

        # Modern CLI tools
        sudo apt install -y \
            fzf \
            ripgrep \
            fd-find \
            bat \
            htop \
            httpie \
            gh \
            gnupg2 \
            golang-go \
            file

        # Install glab manually (not available in Ubuntu apt repos)
        if ! command -v glab &> /dev/null; then
            echo "ðŸ“¦ Installing glab from GitLab releases..."
            GLAB_VERSION=$(curl -s https://gitlab.com/api/v4/projects/gitlab-org%2Fcli/releases | jq -r '.[0].tag_name' | sed 's/^v//')
            # Encode version for URL (replace dots with %2E)
            GLAB_VERSION_ENCODED=$(echo "$GLAB_VERSION" | sed 's/\./%2E/g')
            curl -sSL "https://gitlab.com/api/v4/projects/gitlab-org%2Fcli/packages/generic/glab/${GLAB_VERSION_ENCODED}/glab_${GLAB_VERSION_ENCODED}_linux_amd64%2Etar%2Egz" | sudo tar -xz -C /usr/local/bin bin/glab --strip-components=1
            echo "  glab ${GLAB_VERSION} installed"
        fi

        # Install yazi manually (not available in Ubuntu apt repos)
        if ! command -v yazi &> /dev/null; then
            echo "ðŸ“¦ Installing yazi from GitHub releases..."
            YAZI_VERSION=$(curl -s https://api.github.com/repos/sxyazi/yazi/releases/latest | jq -r '.tag_name')

            # Download and extract yazi
            cd /tmp
            curl -sSL "https://github.com/sxyazi/yazi/releases/download/${YAZI_VERSION}/yazi-x86_64-unknown-linux-gnu.zip" -o yazi.zip
            unzip -q yazi.zip

            # Install binaries
            sudo cp yazi-x86_64-unknown-linux-gnu/yazi /usr/local/bin/
            sudo cp yazi-x86_64-unknown-linux-gnu/ya /usr/local/bin/
            sudo chmod +x /usr/local/bin/yazi /usr/local/bin/ya

            # Cleanup
            rm -rf yazi.zip yazi-x86_64-unknown-linux-gnu

            echo "  yazi ${YAZI_VERSION} installed"
        fi

    elif command -v pacman &> /dev/null; then
        echo "ðŸ“¦ Installing core tools via pacman..."

        sudo pacman -Syu --noconfirm
        sudo pacman -S --noconfirm \
            neovim \
            tmux \
            git \
            curl \
            wget \
            unzip \
            jq \
            python \
            python-pip \
            fzf \
            ripgrep \
            fd \
            bat \
            eza \
            yazi \
            github-cli \
            gitlab-cli \
            go \
            age \
            gnupg \
            dust \
            duf \
            procs \
            docker \
            docker-compose \
            btop \
            htop \
            gitui \
            tldr \
            scc \
            httpie
    fi
    {{- end }}

    echo "  Core tools installation completed"
}

# ===== PACKAGE MANAGER SETUP =====
setup_package_manager() {
    echo "ðŸ“¦ Setting up package managers..."

    {{- if eq .chezmoi.os "darwin" }}
    # macOS - Ensure Homebrew is available
    if ! command -v brew &> /dev/null; then
        echo "ðŸ“¦ Installing Homebrew..."
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        eval "$(/opt/homebrew/bin/brew shellenv)"
    fi
    {{- end }}
}

# ===== MAIN EXECUTION =====
main() {
    echo "  Starting core tools installation..."

    setup_package_manager
    install_core_tools

    echo "  Core tools installation completed successfully"
}

# Run main function
main