# ===== LOGO MICRODON =====
# Afficher le logo Microdon au dÃ©marrage (nouveau pane/terminal)
if [[ -x "$HOME/.local/bin/show-microdon-logo" ]]; then
    "$HOME/.local/bin/show-microdon-logo"
fi

# ===== OUTILS MODERNES =====
# FZF avec intÃ©gration moderne
if command -v fzf &> /dev/null; then
    source <(fzf --zsh)
    export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git'
    export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
    export FZF_ALT_C_COMMAND='fd --type d --hidden --follow --exclude .git'

    # ThÃ¨me Rose Pine pour FZF
    export FZF_DEFAULT_OPTS="
        --color=bg+:#26233a,bg:#191724,spinner:#f6c177,hl:#eb6f92
        --color=fg:#e0def4,header:#eb6f92,info:#c4a7e7,pointer:#f6c177
        --color=marker:#f6c177,fg+:#e0def4,prompt:#c4a7e7,hl+:#eb6f92
        --color=border:#403d52,gutter:#191724,label:#908caa
        --height 40% --layout=reverse --border rounded --preview-window=right:60%
        --bind='ctrl-u:preview-page-up,ctrl-d:preview-page-down'
        --bind='ctrl-/:toggle-preview'
    "

    # Preview pour diffÃ©rents types de fichiers
    export FZF_CTRL_T_OPTS="
        --preview 'bat --color=always --style=numbers --line-range=:500 {} 2>/dev/null || ls -la {}'
        --bind 'ctrl-/:toggle-preview'
    "

    export FZF_ALT_C_OPTS="
        --preview 'eza --tree --level=2 --color=always {} 2>/dev/null || ls -la {}'
    "
fi

# Zoxide (cd amÃ©liorÃ©) avec intÃ©gration FZF
if command -v zoxide &> /dev/null; then
    eval "$(zoxide init zsh)"
    # Alias z avec fzf si disponible
    if command -v fzf &> /dev/null; then
        alias zi='z -i'  # Interactive avec fzf
    fi
fi

# ===== VARIABLES D'ENVIRONNEMENT =====
export EDITOR=nvim
export VISUAL=nvim
export BROWSER=open
export LANG=fr_FR.UTF-8
export LC_ALL=fr_FR.UTF-8

# DÃ©veloppement
export NODE_ENV=development
export COMPOSER_MEMORY_LIMIT=-1
export PHP_IDE_CONFIG="serverName=localhost"

# Rainfrog (PostgreSQL TUI)
export RAINFROG_FAVORITES="${HOME}/.config/rainfrog/favorites"

# Charger variables d'environnement additionnelles depuis .env
[[ -f ~/.env ]] && source ~/.env

# Couleurs pour ls et autres
export CLICOLOR=1
export LS_COLORS="di=34:ln=35:so=32:pi=33:ex=31:bd=34;46:cd=34;43:su=30;41:sg=30;46:tw=30;42:ow=30;43"

# Chemin personnalisÃ©
typeset -U path PATH
path=(
    $HOME/.local/bin
    $HOME/bin
    /opt/homebrew/bin
    /opt/homebrew/sbin
    $HOME/.composer/vendor/bin
    $HOME/.npm-global/bin
    $path
)

# ===== ALIAS MODERNES =====
# Chargement alias depuis fichier sÃ©parÃ©
[[ -f ~/.aliases ]] && source ~/.aliases

# Outils modernes en remplacement des classiques
alias ls='eza --icons --group-directories-first'
alias ll='eza -la --icons --git --group-directories-first'
alias la='eza -la --icons --group-directories-first'
alias lt='eza --tree --icons --level=3'
alias lta='eza --tree --icons --level=3 -a'
alias cat='bat --style=auto'
alias catp='bat --style=plain'  # Sans numÃ©ros de ligne
alias find='fd'

# Git (amÃ©liorations)
alias g='git'
alias ga='git add'
alias gaa='git add --all'
alias gc='git commit'
alias gcm='git commit -m'
alias gco='git checkout'
alias gp='git push'
alias gpl='git pull'
alias gs='git status'
alias gd='git diff'
alias gds='git diff --staged'
alias gl='git log --oneline --graph --decorate --all'
alias lg='lazygit'
alias gclean='git branch --merged | grep -v "\\*\\|main\\|master" | xargs -n 1 git branch -d'

# Tmux (amÃ©liorations)
alias t='tmux'
alias ta='tmux attach'
alias tl='tmux list-sessions'
alias tn='tmux new-session'
alias tk='tmux kill-session'

# DÃ©veloppement moderne
alias sf='symfony'
alias sfc='symfony console'
alias sfcc='symfony console cache:clear'
alias sfserve='symfony serve'
alias sftest='symfony run bin/phpunit'
alias nr='npm run'
alias ni='npm install'
alias nid='npm install --save-dev'
alias nig='npm install -g'
alias nu='npm uninstall'
alias nup='npm update'
alias nlg='npm list -g --depth=0'

# Utilitaires modernes
alias ..='cd ..'
alias ...='cd ../..'
alias ....='cd ../../..'
alias ~='cd ~'
alias h='history'
alias c='clear'
alias e='$EDITOR'
alias v='nvim'
alias reload='exec $SHELL'

# Raccourcis systÃ¨me
alias finder='open -a Finder'
alias brewup='brew update && brew upgrade && brew cleanup'
alias flushdns='sudo dscacheutil -flushcache && sudo killall -HUP mDNSResponder'

# Raccourcis rÃ©seau et systÃ¨me
alias myip='curl -s https://ipinfo.io/ip'
alias localip='ipconfig getifaddr en0 2>/dev/null || hostname -I | cut -d" " -f1'
alias speedtest='curl -s https://raw.githubusercontent.com/sivel/speedtest-cli/master/speedtest.py | python3 -'
alias weather='curl wttr.in/Paris'

# ===== FONCTIONS AVANCÃ‰ES =====
# CrÃ©ation et navigation dans dossier
mkcd() {
    mkdir -p "$1" && cd "$1"
}

# Recherche et remplacement intelligent
replace_in_files() {
    if [[ $# -ne 2 ]]; then
        echo "Usage: replace_in_files 'ancien_texte' 'nouveau_texte'"
        return 1
    fi
    rg -l "$1" | xargs sed -i "s/$1/$2/g"
}

# Extraction archives universelle
extract() {
    if [[ -f $1 ]]; then
        case $1 in
            *.tar.bz2)   tar xjf $1     ;;
            *.tar.gz)    tar xzf $1     ;;
            *.tar.xz)    tar xJf $1     ;;
            *.bz2)       bunzip2 $1     ;;
            *.rar)       unrar x $1     ;;
            *.gz)        gunzip $1      ;;
            *.tar)       tar xf $1      ;;
            *.tbz2)      tar xjf $1     ;;
            *.tgz)       tar xzf $1     ;;
            *.zip)       unzip $1       ;;
            *.Z)         uncompress $1  ;;
            *.7z)        7z x $1        ;;
            *.deb)       ar x $1        ;;
            *.tar.zst)   tar --use-compress-program=unzstd -xf $1 ;;
            *)           echo "'$1' ne peut pas Ãªtre extrait avec extract()" ;;
        esac
    else
        echo "'$1' n'est pas un fichier valide"
    fi
}

# Backup intelligent avec timestamp
backup() {
    local file="$1"
    if [[ -f "$file" ]] || [[ -d "$file" ]]; then
        cp -r "$file" "${file}.backup.$(date +%Y%m%d_%H%M%S)"
        echo "âœ… Backup crÃ©Ã©: ${file}.backup.$(date +%Y%m%d_%H%M%S)"
    else
        echo "âŒ Fichier/dossier '$file' non trouvÃ©"
    fi
}

# Tmux sessionizer avec fzf intÃ©grÃ©
ts() {
    local session_name
    if [[ $# -eq 1 ]]; then
        session_name="$1"
    else
        local search_dirs=(
            ~/projects
            ~/work
            ~/personal
            ~/.config
        )

        local selected_path
        selected_path=$(find "${search_dirs[@]}" -mindepth 1 -maxdepth 2 -type d 2>/dev/null | \
            sed "s|$HOME/||" | \
            fzf --prompt="ðŸ“ Projet: " \
                --height=40% \
                --layout=reverse \
                --border=rounded \
                --preview="eza --tree --level=2 --color=always $HOME/{} 2>/dev/null || ls -la $HOME/{}" \
                --bind='ctrl-/:toggle-preview')

        [[ -z "$selected_path" ]] && return 0
        session_name="$selected_path"
    fi

    local full_path="$HOME/$session_name"
    local clean_name=$(basename "$session_name" | tr . _)

    if [[ -z $TMUX ]] && [[ -z $(pgrep tmux) ]]; then
        tmux new-session -s "$clean_name" -c "$full_path"
        return 0
    fi

    if ! tmux has-session -t="$clean_name" 2> /dev/null; then
        tmux new-session -ds "$clean_name" -c "$full_path"
    fi

    if [[ -z $TMUX ]]; then
        tmux attach -t "$clean_name"
    else
        tmux switch-client -t "$clean_name"
    fi
}

# Workflow dÃ©veloppement Symfony amÃ©liorÃ©
dev-symfony() {
    local project_name="${1:-$(basename $(pwd))}"
    local project_path="${2:-$(pwd)}"

    if [[ ! -f "$project_path/bin/console" ]] && [[ ! -f "$project_path/symfony.lock" ]]; then
        echo "âŒ Projet Symfony non dÃ©tectÃ© dans $project_path"
        return 1
    fi

    ~/.config/tmux/scripts/symfony-dev "$project_name" "$project_path"
}

# Workflow dÃ©veloppement TypeScript amÃ©liorÃ©
dev-ts() {
    local project_name="${1:-$(basename $(pwd))}"
    local project_path="${2:-$(pwd)}"

    if [[ ! -f "$project_path/package.json" ]]; then
        echo "âŒ package.json non trouvÃ© dans $project_path"
        return 1
    fi

    ~/.config/tmux/scripts/typescript-dev "$project_name" "$project_path"
}

# Fonction pour changer de version Node avec gestion automatique
nvm_auto() {
    if [[ -f .nvmrc ]]; then
        local node_version=$(cat .nvmrc)
        echo "ðŸ“¦ Utilisation Node.js version: $node_version"
        nvm use "$node_version"
    elif command -v node &> /dev/null; then
        echo "ðŸ“¦ Node.js version actuelle: $(node --version)"
    else
        echo "âš ï¸ Node.js non installÃ©"
    fi
}

# Auto-switch Node version si .nvmrc existe
cd() {
    builtin cd "$@"
    if [[ -f .nvmrc ]] && command -v nvm &> /dev/null; then
        nvm_auto
    fi
}

# Git helpers avancÃ©s
git_clean_branches() {
    echo "ðŸ§¹ Nettoyage des branches Git..."
    git fetch --prune
    git branch --merged main | grep -v "main\\|master" | xargs -n 1 git branch -d
    git branch -r --merged main | grep -v "main\\|master" | sed 's/origin\\///' | xargs -n 1 git push --delete origin
    echo "âœ… Nettoyage terminÃ©"
}

git_sync() {
    echo "ðŸ”„ Synchronisation avec origin..."
    git fetch --all --prune
    git pull --rebase
    git push
    echo "âœ… Synchronisation terminÃ©e"
}



# ===== INTÃ‰GRATIONS SPÃ‰CIFIQUES =====
# Configuration personnelle
[[ -f ~/.personal_profile ]] && source ~/.personal_profile

# Aliases personnels
alias blog='cd ~/projects/blog && code .'
alias dotfiles='cd ~/.local/share/chezmoi && nvim'

# Chezmoi management aliases
alias chezmoi_wipe='echo "ðŸ§¹ Nettoyage complet des caches et donnÃ©es chezmoi..." && rm -rf ~/.local/share/chezmoi ~/.cache/chezmoi ~/.config/chezmoi/chezmoistate.boltdb* && echo "âœ… Caches chezmoi nettoyÃ©s. Utilisez '\''chezmoi init --apply'\'' pour rÃ©initialiser."'

# ===== HOOKS ET INTEGRATIONS =====
# Hook pour mise Ã  jour automatique des repos Git
update_git_repos() {
    local base_dirs=(~/projects ~/work ~/.config)
    for base_dir in "${base_dirs[@]}"; do
        [[ -d "$base_dir" ]] || continue
        find "$base_dir" -name ".git" -type d | while read -r git_dir; do
            local repo_dir=$(dirname "$git_dir")
            echo "ðŸ”„ Mise Ã  jour: $repo_dir"
            (cd "$repo_dir" && git fetch --prune &>/dev/null)
        done
    done
    echo "âœ… Mise Ã  jour des repos terminÃ©e"
}

# Alias pour mise Ã  jour complÃ¨te du systÃ¨me
update_all() {
    echo "ðŸš€ Mise Ã  jour complÃ¨te du systÃ¨me..."
    echo "ðŸ“¦ Mise Ã  jour Homebrew..."
    brew update && brew upgrade && brew cleanup

    if command -v chezmoi &> /dev/null; then
        echo "âš™ï¸ Mise Ã  jour dotfiles..."
        chezmoi update
    fi

    if [[ -d "$ZSH" ]]; then
        echo "ðŸš Mise Ã  jour Oh My Zsh..."
        omz update
    fi

    if command -v npm &> /dev/null; then
        echo "ðŸ“¦ Mise Ã  jour packages npm globaux..."
        npm update -g
    fi

    update_git_repos

    echo "âœ… Mise Ã  jour complÃ¨te terminÃ©e!"
}

# ===== CONFIGURATION LOCALE =====
# Inclusion configuration spÃ©cifique machine
[[ -f ~/.zshrc.local ]] && source ~/.zshrc.local

# ===== PERFORMANCE DEBUG =====
# DÃ©commenter pour mesurer temps de dÃ©marrage
# zprof

# Message de bienvenue personnalisÃ©
if [[ -o interactive ]] && [[ -z "$TMUX" ]]; then
    echo "ðŸš€ Terminal $(tput setaf 6){{ .chezmoi.username }}$(tput sgr0) sur $(tput setaf 3){{ .chezmoi.hostname }}$(tput sgr0) ({{ .chezmoi.os }}/{{ .chezmoi.arch }})"
    {{- if (index . "personal" | default false) }}
    echo "ðŸ’¼ Mode: $(tput setaf 2)Personnel$(tput sgr0)"
    {{- else if (index . "work" | default false) }}
    echo "ðŸ’¼ Mode: $(tput setaf 3)Travail$(tput sgr0)"
    {{- else }}
    echo "ðŸ’¼ Mode: $(tput setaf 4)Standard$(tput sgr0)"
    {{- end }}
fi

# ===== STARSHIP PROMPT =====
export STARSHIP_CONFIG=~/.config/starship.toml
if command -v starship &> /dev/null; then
    eval "$(starship init zsh)"
fi

# ===== DOCKER & LAZYDOCKER =====
# Docker aliases et raccourcis
alias d='docker'
alias dc='docker-compose'
alias dcu='docker-compose up'
alias dcd='docker-compose down'
alias dcb='docker-compose build'
alias dcr='docker-compose restart'
alias dcp='docker-compose pull'
alias dcl='docker-compose logs'
alias dclf='docker-compose logs -f'
alias dce='docker-compose exec'

# Docker management
alias dps='docker ps'
alias dpsa='docker ps -a'
alias di='docker images'
alias dv='docker volume ls'
alias dn='docker network ls'
alias dprune='docker system prune -af'
alias dvprune='docker volume prune -f'
alias diprune='docker image prune -af'

# Lazydocker
alias lzd='lazydocker'
alias lazy='lazydocker'

# Docker utility functions
docker-clean() {
    echo "ðŸ§¹ Nettoyage Docker complet..."
    docker system prune -af --volumes
    docker builder prune -af
    echo "âœ… Nettoyage terminÃ©"
}

docker-stats() {
    docker stats --format "table {{ "{{" }}.Container{{ "}}" }}\t{{ "{{" }}.CPUPerc{{ "}}" }}\t{{ "{{" }}.MemUsage{{ "}}" }}\t{{ "{{" }}.NetIO{{ "}}" }}\t{{ "{{" }}.BlockIO{{ "}}" }}"
}

docker-logs() {
    if [[ $# -eq 0 ]]; then
        echo "Usage: docker-logs <container_name>"
        return 1
    fi
    docker logs -f --tail=100 "$1"
}

docker-shell() {
    if [[ $# -eq 0 ]]; then
        echo "Usage: docker-shell <container_name> [shell]"
        return 1
    fi
    local shell=${2:-bash}
    docker exec -it "$1" "$shell"
}

docker-ip() {
    if [[ $# -eq 0 ]]; then
        echo "Usage: docker-ip <container_name>"
        return 1
    fi
    docker inspect -f '{{ "{{" }}range .NetworkSettings.Networks{{ "}}" }}{{ "{{" }}.IPAddress{{ "}}" }}{{ "{{" }}end{{ "}}" }}' "$1"
}

# Docker Compose helpers
dc-rebuild() {
    if [[ $# -eq 0 ]]; then
        echo "ðŸ”„ Reconstruction de tous les services..."
        docker-compose down && docker-compose build --no-cache && docker-compose up -d
    else
        echo "ðŸ”„ Reconstruction du service: $1"
        docker-compose stop "$1" && docker-compose build --no-cache "$1" && docker-compose up -d "$1"
    fi
}

dc-fresh() {
    echo "ðŸ†• RedÃ©marrage complet avec reconstruction..."
    docker-compose down -v --remove-orphans
    docker-compose build --no-cache
    docker-compose up -d
    echo "âœ… Environnement Docker redÃ©marrÃ©"
}

# ===== CLAUDE CODE & CCUSAGE =====
{{- if lookPath "claude" }}
# Claude Code helper functions
claude-session() {
    if [[ $# -eq 0 ]]; then
        echo "ðŸ’­ Nouvelle session Claude Code..."
        claude
    else
        echo "ðŸ’­ Claude Code: $*"
        claude "$@"
    fi
}
{{- end }}

# ===== HISTORY CONFIGURATION =====
# Shared history across all shells and tmux panes
HISTFILE="$HOME/.zsh_history"
HISTSIZE=50000              # Commands kept in memory
SAVEHIST=50000              # Commands saved to file (increased from default 10000)

# History options for sharing across tmux panes/windows
setopt SHARE_HISTORY                # Share history immediately across all shells
setopt EXTENDED_HISTORY             # Save timestamps with commands
setopt HIST_EXPIRE_DUPS_FIRST       # Delete duplicates first when HISTFILE exceeds HISTSIZE
setopt HIST_IGNORE_DUPS             # Don't save consecutive duplicate commands
setopt HIST_IGNORE_SPACE            # Ignore commands starting with space
setopt HIST_VERIFY                  # Show expanded history command before running
setopt HIST_FIND_NO_DUPS            # Don't display duplicates when searching history
setopt INC_APPEND_HISTORY           # Write to history file immediately, not on shell exit

# ===== ZSH PLUGINS =====
# Plugin directory
ZSH_CUSTOM=${ZSH_CUSTOM:-~/.oh-my-zsh/custom}

# Load zsh-autosuggestions
if [[ -f "$ZSH_CUSTOM/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh" ]]; then
    source "$ZSH_CUSTOM/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh"
fi

# Load fast-syntax-highlighting (must be last)
if [[ -f "$ZSH_CUSTOM/plugins/fast-syntax-highlighting/fast-syntax-highlighting.plugin.zsh" ]]; then
    source "$ZSH_CUSTOM/plugins/fast-syntax-highlighting/fast-syntax-highlighting.plugin.zsh"
fi

# Load zsh-completions
if [[ -d "$ZSH_CUSTOM/plugins/zsh-completions/src" ]]; then
    fpath=("$ZSH_CUSTOM/plugins/zsh-completions/src" $fpath)
fi

# Initialize completions (ignore insecure system directories)
autoload -Uz compinit
compinit -u

# Load zsh-history-substring-search
if [[ -f "$ZSH_CUSTOM/plugins/zsh-history-substring-search/zsh-history-substring-search.zsh" ]]; then
    source "$ZSH_CUSTOM/plugins/zsh-history-substring-search/zsh-history-substring-search.zsh"
    # Bind keys for history search
    bindkey '^[[A' history-substring-search-up
    bindkey '^[[B' history-substring-search-down
    bindkey '^P' history-substring-search-up
    bindkey '^N' history-substring-search-down
fi

# Note: zsh-z removed - using zoxide instead for better performance

# Load zsh-bat
if [[ -f "$ZSH_CUSTOM/plugins/zsh-bat/zsh-bat.plugin.zsh" ]]; then
    source "$ZSH_CUSTOM/plugins/zsh-bat/zsh-bat.plugin.zsh"
fi

# Configure autosuggestions
ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE="fg=#626880,bold"
ZSH_AUTOSUGGEST_STRATEGY=(history completion)
ZSH_AUTOSUGGEST_BUFFER_MAX_SIZE=20

# Configure history substring search
HISTORY_SUBSTRING_SEARCH_HIGHLIGHT_FOUND="bg=magenta,fg=white,bold"
HISTORY_SUBSTRING_SEARCH_HIGHLIGHT_NOT_FOUND="bg=red,fg=white,bold"

# ===== DUAL-MACHINE FUNCTIONS =====
# Load dual-machine helper functions if available
{{- if or (index . "personal" | default false) (index . "work" | default false) }}
if [[ -f ~/.config/shell/dual-machine-functions.sh ]]; then
    source ~/.config/shell/dual-machine-functions.sh
fi
{{- end }}

# Initialize starship prompt (must be at the end)
{{- if lookPath "starship" }}
if command -v starship &> /dev/null; then
    eval "$(starship init zsh)"
fi
{{- end }}

# Chezmoi Three-Location Sync Helpers (critical for preventing config loss)
if [[ -f ~/.config/shell/chezmoi-sync-helpers.sh ]]; then
    source ~/.config/shell/chezmoi-sync-helpers.sh
fi

# opencode
export PATH="$HOME/.opencode/bin:$PATH"

{{- if lookPath "bun" }}

# bun completions
[ -s "$HOME/.bun/_bun" ] && source "$HOME/.bun/_bun"

# bun
export BUN_INSTALL="$HOME/.bun"
export PATH="$BUN_INSTALL/bin:$PATH"
{{- end }}

