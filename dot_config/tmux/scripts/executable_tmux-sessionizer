#!/usr/bin/env bash

# Tmux Sessionizer - SÃ©lecteur de projet avec fzf
# InspirÃ© par ThePrimeagen mais adaptÃ© pour notre structure

set -euo pipefail

# RÃ©pertoires de recherche (uniquement ceux qui existent)
search_dirs=()
for dir in ~/projects ~/work ~/.config ~/; do
    if [[ -d "$dir" ]]; then
        search_dirs+=("$dir")
    fi
done

# Ajout conditionnel des rÃ©pertoires spÃ©cifiques
{{- if (index . "personal" | default false) }}
if [[ -d ~/personal ]]; then
    search_dirs+=(~/personal)
fi
{{- end }}

{{- if (index . "work" | default false) }}
if [[ -d ~/company ]]; then
    search_dirs+=(~/company)
fi
{{- end }}

# VÃ©rification des dÃ©pendances requises
required_commands=("fzf" "find")
for cmd in "${required_commands[@]}"; do
    if ! command -v "$cmd" &> /dev/null; then
        echo "âŒ Commande requise non trouvÃ©e: $cmd"
        echo "ðŸ’¡ Installer fzf avec: brew install fzf"
        exit 1
    fi
done

# Si un argument est fourni, l'utiliser directement
if [[ $# -eq 1 ]]; then
    selected="$1"
else
    # Recherche des projets avec fd et sÃ©lection avec fzf
    selected=$(find "${search_dirs[@]}" -mindepth 1 -maxdepth 3 -type d 2>/dev/null | \
        grep -E '\.(git|svn)$|package\.json$|composer\.json$|Cargo\.toml$|go\.mod$|requirements\.txt$' -l 2>/dev/null | \
        xargs -I {} dirname {} | \
        sort -u | \
        fzf --prompt="ðŸ“ SÃ©lectionner un projet: " \
            --height=60% \
            --layout=reverse \
            --border=rounded \
            --preview-window=right:50% \
            --preview='
                if [[ -f {}/README.md ]]; then
                    bat --color=always --style=header,grid --line-range=:30 {}/README.md
                elif [[ -f {}/package.json ]]; then
                    echo "ðŸ“¦ Projet Node.js/TypeScript"
                    echo ""
                    jq -r ".name // \"Nom non dÃ©fini\", .description // \"Description non dÃ©finie\", .version // \"Version non dÃ©finie\"" {}/package.json 2>/dev/null | head -3
                    echo ""
                    echo "ðŸ”§ Scripts disponibles:"
                    jq -r ".scripts | keys[]" {}/package.json 2>/dev/null | head -5
                elif [[ -f {}/composer.json ]]; then
                    echo "ðŸ˜ Projet PHP/Symfony"
                    echo ""
                    jq -r ".name // \"Nom non dÃ©fini\", .description // \"Description non dÃ©finie\", .version // \"Version non dÃ©finie\"" {}/composer.json 2>/dev/null | head -3
                    echo ""
                    if [[ -f {}/bin/console ]]; then
                        echo "ðŸŽ¼ Projet Symfony dÃ©tectÃ©"
                    fi
                elif [[ -f {}/Cargo.toml ]]; then
                    echo "ðŸ¦€ Projet Rust"
                    echo ""
                    grep -E "^name|^version|^description" {}/Cargo.toml | head -3
                elif [[ -f {}/go.mod ]]; then
                    echo "ðŸ¹ Projet Go"
                    echo ""
                    head -5 {}/go.mod
                else
                    echo "ðŸ“ Dossier: $(basename {})"
                    echo ""
                    ls -la {} | head -10
                fi
            ' \
            --bind='ctrl-/:toggle-preview' \
            --bind='ctrl-r:reload(find "${search_dirs[@]}" -mindepth 1 -maxdepth 3 -type d 2>/dev/null)' \
            --header='Ctrl+R: Actualiser | Ctrl+/: Toggle preview | Enter: SÃ©lectionner')
fi

# VÃ©rifier si une sÃ©lection a Ã©tÃ© faite
if [[ -z "$selected" ]]; then
    exit 0
fi

# Nettoyer le nom de session (remplacer les caractÃ¨res spÃ©ciaux)
session_name=$(basename "$selected" | tr . _)

# CrÃ©er ou attacher Ã  la session tmux
if [[ -z $TMUX ]] && [[ -z $(pgrep tmux) ]]; then
    # Pas de tmux en cours, crÃ©er une nouvelle session
    tmux new-session -s "$session_name" -c "$selected"
    exit 0
fi

# VÃ©rifier si la session existe dÃ©jÃ 
if ! tmux has-session -t="$session_name" 2> /dev/null; then
    # CrÃ©er la session en arriÃ¨re-plan
    tmux new-session -ds "$session_name" -c "$selected"
    
    # Configuration spÃ©cifique selon le type de projet
    if [[ -f "$selected/package.json" ]]; then
        # Projet Node.js/TypeScript
        tmux send-keys -t "$session_name:1" "clear" Enter
        
        # CrÃ©er des fenÃªtres supplÃ©mentaires pour le dÃ©veloppement
        tmux new-window -t "$session_name" -n "server" -c "$selected"
        tmux new-window -t "$session_name" -n "tests" -c "$selected"
        tmux new-window -t "$session_name" -n "git" -c "$selected"
        
        # Commandes automatiques
        tmux send-keys -t "$session_name:server" "npm run dev" Enter 2>/dev/null || true
        tmux send-keys -t "$session_name:tests" "npm test -- --watch" Enter 2>/dev/null || true
        tmux send-keys -t "$session_name:git" "lazygit" Enter 2>/dev/null || tmux send-keys -t "$session_name:git" "git status" Enter
        
        # Retourner Ã  la premiÃ¨re fenÃªtre
        tmux select-window -t "$session_name:1"
        
    elif [[ -f "$selected/composer.json" ]] || [[ -f "$selected/bin/console" ]]; then
        # Projet PHP/Symfony
        tmux send-keys -t "$session_name:1" "clear" Enter
        
        # CrÃ©er des fenÃªtres pour Symfony
        tmux new-window -t "$session_name" -n "server" -c "$selected"
        tmux new-window -t "$session_name" -n "console" -c "$selected"
        tmux new-window -t "$session_name" -n "tests" -c "$selected"
        tmux new-window -t "$session_name" -n "git" -c "$selected"
        
        # Commandes automatiques
        if [[ -f "$selected/bin/console" ]]; then
            tmux send-keys -t "$session_name:server" "symfony serve" Enter 2>/dev/null || tmux send-keys -t "$session_name:server" "php -S localhost:8000 -t public" Enter
            tmux send-keys -t "$session_name:console" "php bin/console" Enter
        fi
        tmux send-keys -t "$session_name:tests" "vendor/bin/phpunit --testdox" Enter 2>/dev/null || true
        tmux send-keys -t "$session_name:git" "lazygit" Enter 2>/dev/null || tmux send-keys -t "$session_name:git" "git status" Enter
        
        # Retourner Ã  la premiÃ¨re fenÃªtre
        tmux select-window -t "$session_name:1"
        
    else
        # Projet gÃ©nÃ©rique
        tmux send-keys -t "$session_name:1" "clear" Enter
        
        # CrÃ©er une fenÃªtre git si c'est un repo
        if [[ -d "$selected/.git" ]]; then
            tmux new-window -t "$session_name" -n "git" -c "$selected"
            tmux send-keys -t "$session_name:git" "lazygit" Enter 2>/dev/null || tmux send-keys -t "$session_name:git" "git status" Enter
            tmux select-window -t "$session_name:1"
        fi
    fi
fi

# Attacher ou switcher vers la session
if [[ -z $TMUX ]]; then
    tmux attach -t "$session_name"
else
    tmux switch-client -t "$session_name"
fi