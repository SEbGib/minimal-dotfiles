#!/usr/bin/env bash

# Script de dÃ©tection automatique du type de projet
# UtilisÃ© par tmux pour configurer automatiquement l'environnement

set -euo pipefail

project_path="${1:-$(pwd)}"

# VÃ©rification que le chemin existe
if [[ ! -d "$project_path" ]]; then
    echo "âŒ Chemin invalide: $project_path"
    exit 1
fi

# Fonction pour dÃ©tecter le type de projet
detect_project_type() {
    local path="$1"
    
    # VÃ©rification des fichiers dans l'ordre de prioritÃ©
    # Symfony
    if [[ -f "$path/bin/console" ]] || [[ -f "$path/symfony.lock" ]]; then
        echo "symfony"
        return 0
    fi
    
    # Laravel
    if [[ -f "$path/artisan" ]]; then
        echo "laravel"
        return 0
    fi
    
    # Next.js
    if [[ -f "$path/next.config.js" ]] || [[ -f "$path/next.config.ts" ]]; then
        echo "nextjs"
        return 0
    fi
    
    # Nuxt.js
    if [[ -f "$path/nuxt.config.js" ]] || [[ -f "$path/nuxt.config.ts" ]]; then
        echo "nuxtjs"
        return 0
    fi
    
    # Vue.js
    if ([[ -f "$path/vue.config.js" ]] || [[ -f "$path/vite.config.js" ]]) && [[ -f "$path/package.json" ]] && grep -q "vue" "$path/package.json" 2>/dev/null; then
        echo "vue"
        return 0
    fi
    
    # React (gÃ©nÃ©rique)
    if [[ -f "$path/package.json" ]] && grep -q "react" "$path/package.json" 2>/dev/null; then
        echo "react"
        return 0
    fi
    
    # TypeScript/Node.js
    if [[ -f "$path/tsconfig.json" ]] || [[ -f "$path/package.json" ]]; then
        echo "typescript"
        return 0
    fi
    
    # Python
    if [[ -f "$path/requirements.txt" ]] || [[ -f "$path/pyproject.toml" ]] || [[ -f "$path/setup.py" ]]; then
        echo "python"
        return 0
    fi
    
    # Rust
    if [[ -f "$path/Cargo.toml" ]]; then
        echo "rust"
        return 0
    fi
    
    # Go
    if [[ -f "$path/go.mod" ]]; then
        echo "go"
        return 0
    fi
    
    # Docker
    if [[ -f "$path/Dockerfile" ]] || [[ -f "$path/docker-compose.yml" ]]; then
        echo "docker"
        return 0
    fi
    
    # Git repository gÃ©nÃ©rique
    if [[ -d "$path/.git" ]]; then
        echo "git"
        return 0
    fi
    
    echo "generic"
}

# Fonction pour configurer l'environnement selon le type
configure_environment() {
    local project_type="$1"
    local path="$2"
    
    case "$project_type" in
        "symfony")
            echo "ğŸ¼ Projet Symfony dÃ©tectÃ©"
            echo "ğŸ’¡ Utilisez 'dev-symfony' pour un environnement complet"
            ;;
        "laravel")
            echo "ğŸ”¥ Projet Laravel dÃ©tectÃ©"
            echo "ğŸ’¡ Commandes utiles: php artisan serve, php artisan tinker"
            ;;
        "nextjs")
            echo "â–² Projet Next.js dÃ©tectÃ©"
            echo "ğŸ’¡ Utilisez 'dev-ts' pour un environnement complet"
            ;;
        "nuxtjs")
            echo "ğŸ’š Projet Nuxt.js dÃ©tectÃ©"
            echo "ğŸ’¡ Utilisez 'dev-ts' pour un environnement complet"
            ;;
        "vue")
            echo "ğŸ’š Projet Vue.js dÃ©tectÃ©"
            echo "ğŸ’¡ Utilisez 'dev-ts' pour un environnement complet"
            ;;
        "react")
            echo "âš›ï¸ Projet React dÃ©tectÃ©"
            echo "ğŸ’¡ Utilisez 'dev-ts' pour un environnement complet"
            ;;
        "typescript")
            echo "âš¡ Projet TypeScript/Node.js dÃ©tectÃ©"
            echo "ğŸ’¡ Utilisez 'dev-ts' pour un environnement complet"
            ;;
        "python")
            echo "ğŸ Projet Python dÃ©tectÃ©"
            echo "ğŸ’¡ Activez votre environnement virtuel si nÃ©cessaire"
            ;;
        "rust")
            echo "ğŸ¦€ Projet Rust dÃ©tectÃ©"
            echo "ğŸ’¡ Commandes utiles: cargo run, cargo test, cargo build"
            ;;
        "go")
            echo "ğŸ¹ Projet Go dÃ©tectÃ©"
            echo "ğŸ’¡ Commandes utiles: go run, go test, go build"
            ;;
        "docker")
            echo "ğŸ³ Projet Docker dÃ©tectÃ©"
            echo "ğŸ’¡ Commandes utiles: docker-compose up, docker build"
            ;;
        "git")
            echo "ğŸ“ Repository Git dÃ©tectÃ©"
            echo "ğŸ’¡ Utilisez 'lg' pour Lazygit"
            ;;
        *)
            echo "ğŸ“ Projet gÃ©nÃ©rique"
            echo "ğŸ’¡ Utilisez 'ts' pour le sessionizer tmux"
            ;;
    esac
}

# ExÃ©cution principale
project_type=$(detect_project_type "$project_path")
configure_environment "$project_type" "$project_path"

# Retourner le type pour utilisation par d'autres scripts
echo "$project_type"