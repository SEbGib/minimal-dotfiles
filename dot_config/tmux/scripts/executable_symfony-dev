#!/usr/bin/env bash

# Script de workflow Symfony pour tmux
# CrÃ©e un environnement de dÃ©veloppement complet pour Symfony

set -euo pipefail

# ParamÃ¨tres
project_name="${1:-$(basename "$(pwd)")}"
project_path="${2:-$(pwd)}"

# VÃ©rification que le chemin existe
if [[ ! -d "$project_path" ]]; then
    echo "âŒ Chemin invalide: $project_path"
    exit 1
fi

# VÃ©rification que c'est un projet Symfony
if [[ ! -f "$project_path/bin/console" ]] && [[ ! -f "$project_path/symfony.lock" ]]; then
    echo "âŒ Projet Symfony non dÃ©tectÃ© dans $project_path"
    echo "ðŸ’¡ Recherche de bin/console ou symfony.lock"
    exit 1
fi

# VÃ©rification des dÃ©pendances requises
required_commands=("tmux" "php")
for cmd in "${required_commands[@]}"; do
    if ! command -v "$cmd" &> /dev/null; then
        echo "âŒ Commande requise non trouvÃ©e: $cmd"
        exit 1
    fi
done

# Nettoyer le nom de session
session_name="symfony-$(echo "$project_name" | tr . _ | tr '[:upper:]' '[:lower:]')"

echo "ðŸŽ¼ CrÃ©ation de l'environnement Symfony: $session_name"

# Tuer la session si elle existe dÃ©jÃ 
tmux kill-session -t "$session_name" 2>/dev/null || true

# CrÃ©er la session principale
tmux new-session -d -s "$session_name" -c "$project_path" -n "editor"

# FenÃªtre 1: Ã‰diteur (Neovim)
tmux send-keys -t "$session_name:editor" "clear && nvim ." Enter

# FenÃªtre 2: Serveur Symfony
tmux new-window -t "$session_name" -n "server" -c "$project_path"
if command -v symfony &> /dev/null; then
    tmux send-keys -t "$session_name:server" "symfony serve --no-tls" Enter
else
    tmux send-keys -t "$session_name:server" "php -S localhost:8000 -t public" Enter
fi

# FenÃªtre 3: Console Symfony (split en 2)
tmux new-window -t "$session_name" -n "console" -c "$project_path"
tmux split-window -t "$session_name:console" -h -c "$project_path"

# Pane gauche: Console interactive
tmux send-keys -t "$session_name:console.0" "clear" Enter
tmux send-keys -t "$session_name:console.0" "echo 'ðŸŽ¼ Console Symfony - Commandes utiles:'" Enter
tmux send-keys -t "$session_name:console.0" "echo '  â€¢ php bin/console debug:router'" Enter
tmux send-keys -t "$session_name:console.0" "echo '  â€¢ php bin/console make:controller'" Enter
tmux send-keys -t "$session_name:console.0" "echo '  â€¢ php bin/console doctrine:migrations:migrate'" Enter
tmux send-keys -t "$session_name:console.0" "echo '  â€¢ php bin/console cache:clear'" Enter
tmux send-keys -t "$session_name:console.0" "echo ''" Enter

# Pane droite: Base de donnÃ©es / Logs
tmux send-keys -t "$session_name:console.1" "clear" Enter
if [[ -f "$project_path/.env" ]] && grep -q "DATABASE_URL" "$project_path/.env"; then
    tmux send-keys -t "$session_name:console.1" "echo 'ðŸ’¾ Base de donnÃ©es dÃ©tectÃ©e'" Enter
    tmux send-keys -t "$session_name:console.1" "php bin/console doctrine:database:create --if-not-exists" Enter
    tmux send-keys -t "$session_name:console.1" "php bin/console doctrine:migrations:status" Enter
else
    tmux send-keys -t "$session_name:console.1" "echo 'ðŸ“‹ Logs Symfony:'" Enter
    tmux send-keys -t "$session_name:console.1" "tail -f var/log/dev.log" Enter 2>/dev/null || true
fi

# FenÃªtre 4: Tests et qualitÃ© (split en 2)
tmux new-window -t "$session_name" -n "tests" -c "$project_path"
tmux split-window -t "$session_name:tests" -h -c "$project_path"

# Pane gauche: Tests
tmux send-keys -t "$session_name:tests.0" "clear" Enter
if [[ -f "$project_path/phpunit.xml.dist" ]] || [[ -f "$project_path/phpunit.xml" ]]; then
    tmux send-keys -t "$session_name:tests.0" "echo 'ðŸ§ª Tests PHPUnit disponibles'" Enter
    tmux send-keys -t "$session_name:tests.0" "vendor/bin/phpunit --testdox" Enter 2>/dev/null || \
    tmux send-keys -t "$session_name:tests.0" "php bin/phpunit --testdox" Enter 2>/dev/null || \
    tmux send-keys -t "$session_name:tests.0" "echo 'PHPUnit non configurÃ©'" Enter
else
    tmux send-keys -t "$session_name:tests.0" "echo 'âš ï¸ Aucun test configurÃ©'" Enter
    tmux send-keys -t "$session_name:tests.0" "echo 'Pour crÃ©er des tests: php bin/console make:test'" Enter
fi

# Pane droite: QualitÃ© de code
tmux send-keys -t "$session_name:tests.1" "clear" Enter
tmux send-keys -t "$session_name:tests.1" "echo 'ðŸ” Outils de qualitÃ©:'" Enter

# VÃ©rifier les outils de qualitÃ© disponibles
if [[ -f "$project_path/vendor/bin/phpstan" ]]; then
    tmux send-keys -t "$session_name:tests.1" "echo '  â€¢ PHPStan: vendor/bin/phpstan analyse'" Enter
fi

if [[ -f "$project_path/vendor/bin/php-cs-fixer" ]]; then
    tmux send-keys -t "$session_name:tests.1" "echo '  â€¢ PHP-CS-Fixer: vendor/bin/php-cs-fixer fix --dry-run'" Enter
fi

if [[ -f "$project_path/vendor/bin/phpcs" ]]; then
    tmux send-keys -t "$session_name:tests.1" "echo '  â€¢ PHPCS: vendor/bin/phpcs'" Enter
fi

# FenÃªtre 5: Git (Lazygit)
tmux new-window -t "$session_name" -n "git" -c "$project_path"
if command -v lazygit &> /dev/null; then
    tmux send-keys -t "$session_name:git" "lazygit" Enter
else
    tmux send-keys -t "$session_name:git" "git status" Enter
    tmux send-keys -t "$session_name:git" "echo 'ðŸ’¡ Installez lazygit pour une meilleure expÃ©rience Git'" Enter
fi

# FenÃªtre 6: Monitoring (optionnelle)
if command -v htop &> /dev/null || command -v top &> /dev/null; then
    tmux new-window -t "$session_name" -n "monitor" -c "$project_path"
    tmux split-window -t "$session_name:monitor" -v -c "$project_path"
    
    # Pane haut: Processus systÃ¨me
    if command -v htop &> /dev/null; then
        tmux send-keys -t "$session_name:monitor.0" "htop" Enter
    else
        tmux send-keys -t "$session_name:monitor.0" "top" Enter
    fi
    
    # Pane bas: Logs en temps rÃ©el
    tmux send-keys -t "$session_name:monitor.1" "clear" Enter
    tmux send-keys -t "$session_name:monitor.1" "echo 'ðŸ“Š Monitoring du projet Symfony'" Enter
    if [[ -f "$project_path/var/log/dev.log" ]]; then
        tmux send-keys -t "$session_name:monitor.1" "tail -f var/log/dev.log" Enter
    fi
fi

# Retourner Ã  la fenÃªtre Ã©diteur
tmux select-window -t "$session_name:editor"

# Attacher Ã  la session
if [[ -z ${TMUX:-} ]]; then
    tmux attach-session -t "$session_name"
else
    tmux switch-client -t "$session_name"
fi

echo ""
echo "âœ… Environnement Symfony '$session_name' crÃ©Ã© avec succÃ¨s!"
echo ""
echo "ðŸ“‹ FenÃªtres disponibles:"
echo "   1. editor  - Neovim avec le projet"
echo "   2. server  - Serveur Symfony (localhost:8000)"
echo "   3. console - Console Symfony + DB/Logs"
echo "   4. tests   - Tests PHPUnit + QualitÃ© de code"
echo "   5. git     - Lazygit pour le contrÃ´le de version"
if command -v htop &> /dev/null; then
    echo "   6. monitor - Monitoring systÃ¨me + Logs"
fi
echo ""
echo "ðŸŽ¯ Raccourcis tmux:"
echo "   â€¢ Ctrl+Space + 1-6 : Naviguer entre les fenÃªtres"
echo "   â€¢ Ctrl+Space + |   : Split vertical"
echo "   â€¢ Ctrl+Space + -   : Split horizontal"
echo "   â€¢ Alt + hjkl       : Naviguer entre les panes"